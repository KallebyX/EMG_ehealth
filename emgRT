import dash
from dash import dcc, html
from dash.dependencies import Input, Output
import plotly.graph_objs as go
import serial
import numpy as np
from scipy.signal import butter, filtfilt, iirnotch
import threading
import queue

# Configuração da porta serial
port = 'COM3'
baud_rate = 115200
ser = serial.Serial(port, baudrate=baud_rate, timeout=1)

# Fila para armazenar dados recebidos
data_queue = queue.Queue()

# Função de filtragem
def apply_filters(data, fs=1000):
    low_cutoff = 20
    b, a = butter(6, low_cutoff / (0.5 * fs), btype='low')
    low_passed = filtfilt(b, a, data)
    notch_freq = 75
    quality_factor = 45
    b, a = iirnotch(notch_freq / (0.5 * fs), quality_factor)
    notch_filtered = filtfilt(b, a, low_passed)
    return notch_filtered

# Thread para ler dados da porta serial
def serial_thread():
    while True:
        if ser.in_waiting:
            line = ser.readline().decode().strip()
            try:
                value = float(line)
                data_queue.put(value)
            except ValueError:
                continue

# Iniciar thread de leitura serial
thread = threading.Thread(target=serial_thread)
thread.daemon = True
thread.start()

# Configuração inicial do Dash
app = dash.Dash(__name__)
app.layout = html.Div([
    dcc.Graph(id='live-graph', animate=True),
    dcc.Interval(
        id='graph-update',
        interval=1000,  # in milliseconds
        n_intervals=0
    )
])

# Callback para atualizar o gráfico
@app.callback(
    Output('live-graph', 'figure'),
    [Input('graph-update', 'n_intervals')]
)
def update_graph_scatter(n):
    data = []
    while not data_queue.empty() and len(data) < 200:
        data.append(data_queue.get())
    if data:
        filtered_data = apply_filters(np.array(data))
        X = list(range(len(filtered_data)))

        plot_data = go.Scatter(
            x=list(X),
            y=filtered_data,
            name='Scatter',
            mode='lines+markers'
        )

        return {'data': [plot_data], 'layout' : go.Layout(xaxis=dict(range=[min(X), max(X)]), yaxis=dict(range=[min(filtered_data), max(filtered_data)]))}
    return dash.no_update

if __name__ == '__main__':
    app.run_server(debug=True)
pip install dash plotly numpy scipy pyserial
